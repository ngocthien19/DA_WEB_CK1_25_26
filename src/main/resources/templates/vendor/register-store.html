<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng ký cửa hàng - PetShop</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/vendor/register-store.css}">
    <link rel="stylesheet" th:href="@{/css/web/maps.css}">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="f_flex">
                <a th:href="@{/}" class="logo-text">
                    <i class="fa-solid fa-paw"></i>
                    <span>PetShop</span>
                </a>
                <div class="seller-channel">
                    <i class="fa-solid fa-store"></i>
                    <span>Kênh người bán hàng</span>
                </div>
            </div>
            <div class="user-info">
                <i class="fa fa-user"></i>
                <span id="currentUser" th:text="${currentUser?.tenNguoiDung} ?: 'Nguyễn Văn A'">Nguyễn Văn A</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="register-container">
            <div class="register-header">
			    <h1>Đăng ký cửa hàng</h1>
			    <p>Hoàn thành biểu mẫu dưới đây để đăng ký cửa hàng của bạn trên PetShop</p>
			    
			    <div th:if="${errorMessage}" class="alert alert-error">
			        <span th:text="${errorMessage}"></span>
			    </div>
			    <div th:if="${error}" class="alert alert-error">
			        <span th:text="${error}"></span>
			    </div>
			</div>

            <form id="storeRegisterForm" th:action="@{/register-store}" th:object="${cuaHangModel}" method="post" enctype="multipart/form-data">
                <div class="form-row">
                    <div class="form-group" id="group-tenCuaHang">
                        <label for="tenCuaHang">Tên cửa hàng <span style="color: #e94560;">*</span></label>
                        <input type="text" id="tenCuaHang" th:field="*{tenCuaHang}" placeholder="Nhập tên cửa hàng" required maxlength="100">
                        <div class="error" th:if="${#fields.hasErrors('tenCuaHang')}" th:errors="*{tenCuaHang}"></div>
                        <div class="error" id="error-tenCuaHang"></div>
                    </div>
                    <div class="form-group" id="group-namThanhLap">
                        <label for="namThanhLap">Năm thành lập</label>
                        <input type="number" id="namThanhLap" th:field="*{namThanhLap}" min="1900" max="2024" placeholder="VD: 2020">
                        <div class="error" id="error-namThanhLap"></div>
                    </div>
                </div>

                <div class="form-group" id="group-moTa">
                    <label for="moTa">Mô tả cửa hàng</label>
                    <textarea id="moTa" th:field="*{moTa}" placeholder="Mô tả ngắn gọn về cửa hàng của bạn" maxlength="500"></textarea>
                </div>

                <div class="form-group" id="group-diaChi">
                    <label for="diaChi">Địa chỉ cửa hàng <span style="color: #e94560;">*</span></label>
                    <input type="text" id="diaChi" th:field="*{diaChi}" placeholder="Nhập địa chỉ đầy đủ" required maxlength="255">
                    <div class="error" th:if="${#fields.hasErrors('diaChi')}" th:errors="*{diaChi}"></div>
                    <div class="error" id="error-diaChi"></div>
                </div>
                
                <!-- Hidden fields for coordinates -->
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
                
                <!-- Map Controls -->
                <div class="map-controls" style="margin-bottom: 15px;">
                    <button type="button" class="btn btn-secondary" onclick="searchStoreAddress()" style="margin-right: 10px;">
                        <i class="fas fa-search"></i> Tìm trên bản đồ
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="getStoreCurrentLocation()">
                        <i class="fas fa-location-arrow"></i> Vị trí hiện tại
                    </button>
                </div>
                
                <!-- Map Container -->
                <div class="map-container" id="mapContainer" style="display: none; margin-bottom: 20px;">
                    <div id="map"></div>
                </div>
                <div class="map-info" id="mapInfo" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    <span>Kéo marker hoặc click vào bản đồ để chọn vị trí chính xác cho cửa hàng</span>
                </div>

                <div class="form-row">
                    <div class="form-group" id="group-soDienThoai">
                        <label for="soDienThoai">Số điện thoại <span style="color: #e94560;">*</span></label>
                        <input 
                            type="tel" 
                            id="soDienThoai" 
                            th:field="*{soDienThoai}" 
                            placeholder="VD: 0912345678" 
                            required 
                            pattern="0[0-9]{9}"
                            title="Số điện thoại phải bắt đầu bằng 0 và có đủ 10 chữ số."
                            maxlength="10"
                        >
                        <div class="error" th:if="${#fields.hasErrors('soDienThoai')}" th:errors="*{soDienThoai}"></div>
                        <div class="error" id="error-soDienThoai"></div> </div>
                    <div class="form-group" id="group-email">
                        <label for="email">Email <span style="color: #e94560;">*</span></label>
                        <input type="email" id="email" th:field="*{email}" placeholder="VD: example@gmail.com" required maxlength="150">
                        <div class="error" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
                        <div class="error" id="error-email"></div>
                    </div>
                </div>

                <div class="upload-container">
                    <label>Ảnh đại diện cửa hàng</label>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                        </div>
                        <div class="upload-text">
                            <h4>Kéo thả ảnh vào đây hoặc nhấn để tải lên</h4>
                            <p>Hỗ trợ JPG, PNG, GIF - Tối đa 5MB</p>
                        </div>
                        <div class="upload-btn">Chọn ảnh</div>
                        <input type="file" id="storeImage" name="storeImage" accept="image/*" style="display: none;">
                    </div>
                    <div class="upload-preview" id="uploadPreview">
                        <img src="" alt="Preview" class="preview-image" id="previewImage">
                        <div class="preview-actions">
                            <button type="button" class="preview-btn preview-change" id="changeImage">Thay đổi</button>
                            <button type="button" class="preview-btn preview-remove" id="removeImage">Xóa ảnh</button>
                        </div>
                    </div>
                    <input type="hidden" id="hinhAnh" th:field="*{hinhAnh}">
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="agreeTerms" name="agreeTerms" required>
                    <label for="agreeTerms">Tôi đã đọc và đồng ý với <a href="#">Điều khoản dịch vụ</a> và <a href="#">Chính sách bảo mật</a> của PetShop</label>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="window.history.back()">Quay lại</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <span class="btn-text">Đăng ký cửa hàng</span>
                        <span class="loading" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet JS - KHÔNG CẦN API KEY! -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Load maps helper -->
    <script th:src="@{/js/web/maps-leaflet.js}"></script>
    
    <script th:src="@{/js/vendor/register-store.js}"></script>
    <script>
        // Google Maps functions for store registration
        let storeMapInitialized = false;
        
        function searchStoreAddress() {
            const address = document.getElementById('diaChi').value.trim();
            if (!address) {
                alert('Vui lòng nhập địa chỉ cửa hàng trước');
                return;
            }
            
            showStoreMap();
            if (window.mapsHelper) {
                window.mapsHelper.geocodeAddress(address);
            }
        }
        
        function getStoreCurrentLocation() {
            showStoreMap();
            if (window.mapsHelper) {
                window.mapsHelper.getCurrentLocation();
            }
        }
        
        function showStoreMap() {
            document.getElementById('mapContainer').style.display = 'block';
            document.getElementById('mapInfo').style.display = 'block';
            
            if (!storeMapInitialized && window.mapsHelper) {
                window.mapsHelper.initMap('map');
                window.mapsHelper.initAutocomplete('diaChi');
                storeMapInitialized = true;
            }
        }
        
        // Auto show map when address is entered
        document.getElementById('diaChi').addEventListener('focus', function() {
            if (this.value.trim()) {
                showStoreMap();
            }
        });
    </script>
</body>
</html>